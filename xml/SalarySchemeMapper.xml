<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.linkstec.lmspcom.newsalary.mapper.SalarySchemeMapper">

	<!-- 查询薪酬项目名称 -->
	<select id="selectSalaryItemName" resultType="java.lang.String"
		parameterType="map">
		SELECT SALARY_NAME||'('||SALARY_CODE||')' FROM T_XCITEM
		<where>
			SALARY_CODE IN
			<foreach collection="itemIds" open="(" separator="," close=")"
				item="item">
				#{item}
			</foreach>
		</where>
	</select>

	<!-- 查询经营单元名称 -->
	<select id="selectBusiNameById" resultType="java.lang.String"
		parameterType="map">
		select JG_NAME AS JYDY_NAME from L_ORGANIZATION_EXPAND where JGID = #{id}
	</select>

	<!-- 查询经纪人名称 -->
	<select id="slectJJRNameById" resultType="java.lang.String"
		parameterType="map">
		select XM from T_EHR_JJR_JBXX where RYID = #{id}
	</select>

	<!-- 根据客户和客户关系查询经济人 -->
	<select id="selectJJRByCust" resultType="map" parameterType="map">
		select DISTINCT B.GXLXBH "relType",B.SHZT "auditState",B.KHID
		"custId",A.RYID "num",A.XM "name"
		from T_EHR_JJR_JBXX A INNER JOIN
		t_gxgl_gxmx B on A.RYID=B.RYID
		<where>
			<if test="custId!=null">
				and B.KHID = #{custId}
			</if>
			<if test="flowState!=null">
				and B.SHZT = #{flowState}
			</if>
		</where>
	</select>

	<!-- 查询客户名称 -->
	<select id="selectCustNameById" resultType="java.lang.String"
		parameterType="map">
		select KHXM from T_KH_XX where KHID = #{id}
	</select>

	<select id="selectCalIndex" resultType="com.linkstec.lmspcom.newsalary.dto.CalIndexDto"
		parameterType="map">
		select ID id,CAL_ID calId,CAL_NAME calName,CAL_LEVEL calLevel
		from
		T_ZBCALSET
		<where>
			<if test="calType!=null">
				and CAL_TYPE = #{calType}
			</if>
		</where>
		order by CAL_LEVEL
	</select>

	<!-- 根据部门查询人员 -->
	<select id="selectmemIdByOrgId" parameterType="map" resultType="java.lang.Long">
		SELECT
		M.RYID
		FROM
		T_EHR_JJR_JBXX M
		INNER JOIN L_ORGANIZATION_EXPAND Y on M.JGID = Y.JGID
		<where>
			<if test="orgIds!=null">
				and Y.JGID IN
				<foreach collection="orgIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	<!-- 查找方案 -->
	<select id="selectSchemeByCondition" resultType="com.linkstec.lmspcom.newsalary.dto.SalarySchemeDto"
		parameterType="map">
		SELECT
		SCHEDULE_DESC schemeDesc,
		SCHEME_ID schemeId,
		SCHEME_XCITEMS
		schemeItem,
		SCHEME_USE_OBJTYPE useType,
		SCHEME_USE_OBJLEVEL useLevel,
		SCHEME_USE_DEP useDepId,SCHEME_USE_DEPTYPE useDepType
		FROM
		T_XCSCHEME
		<where>
			<if test="schemeUserId!=null">
				and SCHEME_USER_ID = #{schemeUserId}
			</if>
			<if test="schemeUserId==null">
				and SCHEME_USER_ID is null
			</if>
			<if test="useType!=null">
				and (SCHEME_USE_OBJTYPE = #{useType} or
				SCHEME_USE_OBJTYPE is null)
			</if>

			<if test="useLevel!=null">
				and (SCHEME_USE_OBJLEVEL = #{useLevel} or
				SCHEME_USE_OBJLEVEL is null)
			</if>

			<if test="depIds!=null">
				and (SCHEME_USE_DEP IN
				<foreach collection="depIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
				or SCHEME_USE_DEP is null)
			</if>
			<if test="depType!=null">
				and SCHEME_USE_DEPTYPE = #{depType}
			</if>
		</where>
	</select>
	<!-- 递归查询经营单元 -->
	<select id="selectdepIdAndSuperId" parameterType="map"
		resultType="com.linkstec.lmspcom.newsalary.dto.BusiDepDto">
		select JGID id,SUPER_ID superId
		from L_ORGANIZATION_EXPAND

		start with
		JGID = #{id} and JG_STATUS = 1
		connect by prior SUPER_ID = JGID
		ORDER BY SUPER_ID
	</select>

	<!-- 根据人员查询经营单元和分类分级 -->
	<select id="selectBusiDepAndLevelInfo" parameterType="map"
		resultType="com.linkstec.lmspcom.newsalary.dto.MemInfoDto">
		SELECT DISTINCT jjr.RYID ryid,jjr.CURRENT_PLEVEL
		plevel,jjr.CURRENT_TYPE
		ptype,jjr.JGID busiDepId
		from T_EHR_JJR_JBXX
		jjr
		where 1 = 1
		and
		jjr.RYID = #{memberId}
		
	</select>

	<!-- 查询科目手工值 -->
	<select id="selectItemFixValue" parameterType="map"
		resultType="com.linkstec.lmspcom.newsalary.dto.SalaryItemValueDto">
		select f.BUSI_ORG busiDepId,f.USER_ID itemUserId,f.ITEM_CODE
		itemCode,f.FIX_VALUE itemValue,m.SALARY_NAME itemName,f.MEM_TYPE
		memType,f.MEM_LEVEL memLevel,f.MEM_DEPTYPE depType from
		T_XCITEM_FIXVALUE f
		LEFT JOIN T_XCITEM
		m on f.ITEM_CODE=m.SALARY_CODE
		<where>
			<if test="busiDepId!=null">
				and f.BUSI_ORG = #{busiDepId}
			</if>
			<if test="userId!=null">
				and f.USER_ID = #{userId}
			</if>
			<if test="memType!=null">
				and (f.MEM_TYPE=#{memType} or f.MEM_TYPE is null)
			</if>
			<if test="memLevel!=null">
				and (f.MEM_LEVEL=#{memLevel} or f.MEM_LEVEL is null)
			</if>
			<if test="itemId!=null">
				and f.ITEM_CODE = #{itemId}
			</if>
			<if test="depIds!=null">
				and (f.BUSI_ORG IN
				<foreach collection="depIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
				or f.BUSI_ORG is null)
			</if>
			<if test="depType!=null">
				and f.MEM_DEPTYPE = #{depType}
			</if>
			<if test="calTimeStart!=null and calTimeEnd!=null">
			and (f.START_TIME is null or to_char(f.START_TIME,'YYYYMMDD') &lt;= to_char(#{calTimeStart},'YYYYMMDD'))
			and (f.END_TIME is null or to_char(f.END_TIME,'YYYYMMDD') &gt;= to_char(#{calTimeEnd},'YYYYMMDD'))
		</if>
		</where>
	</select>

	<!-- 查询指标手工值 -->
	<select id="selectFixIndexValue" resultType="java.math.BigDecimal"
		parameterType="map">
		select INDEX_VALUE from T_XCZB_INPUTVALUE
		where INDEX_CODE =
		#{indexCode}
		and MEM_ID = #{memId}
		<if test="calTimeStart!=null and calTimeEnd!=null">
			and (START_TIME is null or to_char(START_TIME,'YYYYMMDD') &lt;= to_char(#{calTimeStart},'YYYYMMDD'))
			and (END_TIME is null or to_char(END_TIME,'YYYYMMDD') &gt;= to_char(#{calTimeEnd},'YYYYMMDD'))
		</if>

	</select>

	<!-- 查询科目公式和公式参数 -->
	<select id="selectSalaryItemByCondition" parameterType="map"
		resultType="com.linkstec.lmspcom.newsalary.dto.SalaryItemExpDto">
		select distinct e.ITEM_EXP itemExp,e.ITEM_EXP_CALTYPE
		itemExpCalType,u.SALARY_EXP_PARAM expParam,e.ITEM_CUST_REL itemCustRel,
		e.ITEM_INDEX_BUSTWEIGHT
		weight,u.SALARY_USR_DEP
		busiDepId,u.SALARY_USR_LEVEL
		memLevel,u.SALARY_USR_TYPE
		memType,u.SALARY_USER memId,u.SALARY_USR_DEPTYPE depType
		from T_XCITEM_USE
		u LEFT JOIN T_XCITEM_EXP
		e on u.SALARY_EXP_ID = e.ID
		<where>
			<if test="itemId!=null">
				and u.SALARY_CODE = #{itemId}
			</if>
			<if test="itemMemId!=null">
				and u.SALARY_USER = #{itemMemId}
			</if>
			<if test="itemMemType!=null">
				and (u.SALARY_USR_TYPE = #{itemMemType} or
				u.SALARY_USR_TYPE is null)
			</if>
			<if test="itemMemLevel!=null">
				and (u.SALARY_USR_LEVEL = #{itemMemLevel} or
				u.SALARY_USR_LEVEL is null)
			</if>

			<if test="busiDepIds!=null">
				and (u.SALARY_USR_DEP IN
				<foreach collection="busiDepIds" open="(" separator=","
					close=")" item="item">
					#{item}
				</foreach> 
				or u.SALARY_USR_DEP  is null
				)
			</if>
			<if test="depType!=null">
				and u.SALARY_USR_DEPTYPE = #{depType}
			</if>
		</where>
	</select>

	<!-- 动态SQL查询指标值 -->
	<select id="findIndexValue" resultType="java.math.BigDecimal"
		parameterType="map">
		${sql}
	</select>

	<!-- 查询个人提成模版 -->
	<select id="selectOnlyMemCommissionModel"
		resultType="com.linkstec.lmspcom.newsalary.dto.CommissionModelInfoDto"
		parameterType="map">
		SELECT distinct
		ms.ID commissionId,
		M.MODEL_ID modelId,
		ms.COMMISSION_NAME||'【'||M.MODEL_NAME||'】' commissionName,
		ms.COMMISSION_CAL_TYPE commissionCalType,
		ms.COMMISSION_EXP_TYPE
		commissionExpType,
		ms.COMMISSION_CONDITION
		commissionCondition,
		uo.USROBJ_TYPE objType,
		ms.COMMISSION_VALUE
		commissionValue,
		ms.CUST_REL
		modelCustRel,
		ms.COMMISSION_TYPE commissionType,
		M.MODEL_WEIGHT
		modelWeight,
		M.MODEL_PARAM modelParam,
		M.DIS_ADD_COST disAddCost,
		ms.COMMISSION_PARAM commissionParam,
		uo.CUST_ID custId,
		uo.USER_ID
		memId,
		uo.CUST_TYPE custType
		FROM
		T_XCMODEL_USROBJ uo
		LEFT JOIN
		T_XCTCMODEL M ON uo.MODEL_ID
		= M.MODEL_ID
		LEFT JOIN T_XCTCGSDY ms ON
		M.MODEL_FORMUAL_ID = ms.ID
		WHERE
		uo.USROBJ_TYPE = '1'
		and (uo.AUDIT_STATE='1' or uo.AUDIT_STATE='3'  or uo.AUDIT_STATE like '3`%')
		<if test="memId!=null">
			and uo.USER_ID = #{memId}
		</if>
		<if test="commissionType!=null">
			and ms.COMMISSION_TYPE = #{commissionType}
		</if>
	</select>

	<!-- 查询单户提成模版 -->
	<select id="selectCustCommissionModel"
		resultType="com.linkstec.lmspcom.newsalary.dto.CommissionModelInfoDto"
		parameterType="map">
		SELECT distinct
		ms.ID commissionId,
		M.MODEL_ID modelId,
		ms.COMMISSION_NAME||'【'||M.MODEL_NAME||'】' commissionName,
		ms.COMMISSION_CAL_TYPE commissionCalType,
		ms.COMMISSION_EXP_TYPE
		commissionExpType,
		ms.COMMISSION_CONDITION
		commissionCondition,
		uo.USROBJ_TYPE objType,
		ms.COMMISSION_VALUE
		commissionValue,
		ms.CUST_REL
		modelCustRel,
		ms.COMMISSION_TYPE commissionType,
		M.MODEL_WEIGHT
		modelWeight,
		M.MODEL_PARAM modelParam,
		M.DIS_ADD_COST disAddCost,
		ms.COMMISSION_PARAM commissionParam,
		uo.CUST_ID custId,
		uo.USER_ID memId
		FROM
		T_XCMODEL_USROBJ uo
		LEFT JOIN
		T_XCTCMODEL M ON uo.MODEL_ID =
		M.MODEL_ID
		LEFT JOIN T_XCTCGSDY ms ON
		M.MODEL_FORMUAL_ID = ms.ID
		WHERE
		uo.USROBJ_TYPE = '2'
		and (uo.AUDIT_STATE='1' or uo.AUDIT_STATE='3' or uo.AUDIT_STATE like '3`%')
		<if test="custId!=null">
			and uo.CUST_ID = #{custId}
		</if>
		<if test="memId!=null">
			and uo.USER_ID = #{memId}
		</if>
		<if test="commissionType!=null">
			and ms.COMMISSION_TYPE = #{commissionType}
		</if>
	</select>

	<!-- 查询人员提成模版 -->
	<select id="selectMemCommissionModel"
		resultType="com.linkstec.lmspcom.newsalary.dto.CommissionModelInfoDto"
		parameterType="map">
		SELECT distinct
		ms.ID commissionId,
		M.MODEL_ID modelId,
		ms.COMMISSION_NAME||'【'||M.MODEL_NAME||'】' commissionName,
		ms.COMMISSION_CAL_TYPE commissionCalType,
		ms.COMMISSION_EXP_TYPE
		commissionExpType,
		uo.USROBJ_TYPE objType,
		ms.COMMISSION_CONDITION
		commissionCondition,
		ms.COMMISSION_VALUE
		commissionValue,
		ms.CUST_REL
		modelCustRel,
		ms.COMMISSION_PARAM commissionParam,
		ms.COMMISSION_TYPE
		commissionType,
		M.MODEL_WEIGHT modelWeight,
		M.MODEL_PARAM modelParam,
		M.DIS_ADD_COST
		disAddCost,
		uo.ORG_ID depId,
		uo.USER_LEVEL memLevel,
		uo.USER_TYPE
		memType,
		uo.CUST_TYPE custType,UO.USER_DEPTYPE depType
		FROM
		T_XCMODEL_USROBJ uo
		LEFT
		JOIN
		T_XCTCMODEL M ON uo.MODEL_ID = M.MODEL_ID
		LEFT JOIN T_XCTCGSDY ms
		ON
		M.MODEL_FORMUAL_ID = ms.ID
		WHERE
		uo.USROBJ_TYPE = '1'
		and (uo.AUDIT_STATE='1' or uo.AUDIT_STATE='3'  or uo.AUDIT_STATE like '3`%')
		<if test="memId!=null">
			and uo.USER_ID = #{memId}
		</if>
		<if test="commissionType!=null">
			and ms.COMMISSION_TYPE = #{commissionType}
		</if>
		<if test="memId==null">
			and uo.USER_ID is NULL
		</if>
		<if test="memType!=null">
			and (uo.USER_TYPE = #{memType} or uo.USER_TYPE is null)
		</if>

		<if test="memLevel!=null">
			and (uo.USER_LEVEL = #{memLevel} or uo.USER_LEVEL is null)
		</if>

		<if test="depIds!=null">
			and (uo.ORG_ID IN
			<foreach collection="depIds" open="(" separator="," close=")"
				item="item">
				#{item}
			</foreach>
			or uo.ORG_ID is null)
		</if>
		<if test="depType!=null">
			and UO.USER_DEPTYPE = #{depType}
		</if>
		<!-- <if test="commissionIds!=null"> -->
		<!-- and ms.ID not in -->
		<!-- <foreach collection="commissionIds" open="(" separator="," -->
		<!-- close=")" item="item"> -->
		<!-- #{item} -->
		<!-- </foreach> -->
		<!-- </if> -->
	</select>

	<!-- 查询成本 -->
	<select id="selectCostByCondition" parameterType="map"
		resultType="java.math.BigDecimal">
		SELECT sum(COST_VALUE)
		from (
		select cs.*  FROM T_COST_SET cs LEFT JOIN T_COST_JBXX jbxx ON cs.COST_ID = jbxx.COST_ID
		where  cs.DELETE_FLAG=1
			<if test="costSX">
				AND cs.COST_SX=#{costSX}
			</if>
			<if test="memId!=null">
				AND cs.MEMBER_ID=#{memId}
			</if>
			<if test="custId!=null">
				and cs.CUST_ID=#{custId}
			</if>
			<if test="custRel!=null">
				and cs.GX_TYPE=#{custRel}
			</if>
			<if test="custTypes!=null">
				and EXISTS (
				select tct.ID from T_CUST_TYPE tct where
				cs.CUST_SET_ID = tct.ID
				and tct.KHFLDM = #{custTypes}
				)
			</if>
			<if test="custTypes==null">
				and cs.CUST_SET_ID is null
			</if>
			<if test="calTimeStart!=null and calTimeEnd!=null">
				and JBXX.cost_type = 2 
				and to_date(cs.COST_BEGIN_TIME,'YYYYMMDD') &lt;=
				to_date(#{calTimeStart},'YYYYMMDD')
				and to_date(cs.COST_END_TIME,'YYYYMMDD')
				&gt;= to_date(#{calTimeEnd},'YYYYMMDD')
			</if>
		union  
		SELECT cs.*
		FROM T_COST_SET cs LEFT JOIN T_COST_JBXX jbxx ON cs.COST_ID = jbxx.COST_ID
		where cs.DELETE_FLAG=1
			<if test="costSX">
				AND cs.COST_SX=#{costSX}
			</if>
			<if test="memId!=null">
				AND cs.MEMBER_ID=#{memId}
			</if>
			<if test="custId!=null">
				and cs.CUST_ID=#{custId}
			</if>
			<if test="custRel!=null">
				and cs.GX_TYPE=#{custRel}
			</if>
			<if test="custTypes!=null">
				and EXISTS (
				select tct.ID from T_CUST_TYPE tct where
				cs.CUST_SET_ID = tct.ID
				and tct.KHFLDM = #{custTypes}
				)
			</if>
			<if test="custTypes==null">
				and cs.CUST_SET_ID is null
			</if>
			<if test="calTimeStart!=null and calTimeEnd!=null">
				and JBXX.cost_type = 1 
				AND TO_DATE (cs.COST_BEGIN_TIME,'YYYYMMDD') &gt;= TO_DATE (#{calTimeStart}, 'YYYYMMDD')
				and TO_DATE (cs.COST_END_TIME,'YYYYMMDD') &lt;= TO_DATE (#{calTimeEnd}, 'YYYYMMDD')
			</if>
			)
	</select>

	<!-- 当前经纪人、关系、分类的所有客户中未设置单户模版的客户成本 -->
	<select id="selectCustCostByCondition" parameterType="map"
		resultType="com.linkstec.lmspcom.newsalary.dto.CustInfoDto">
		SELECT distinct cs.COST_VALUE costValue,cs.CUST_ID custId,gmx.BL_FC
		fcbl
		FROM T_COST_SET cs
		inner join (select distinct gm.KHID,gm.BL_FC
		from T_GXGL_GXMX gm
		where
		not EXISTS(
		SELECT uo.ID
		FROM T_XCMODEL_USROBJ
		uo
		LEFT JOIN T_XCTCMODEL M ON uo.MODEL_ID =M.MODEL_ID
		WHERE
		uo.USROBJ_TYPE = '2' and uo.CUST_ID = to_char(gm.KHID)
		<if test="custRel!=null">
		and uo.CUST_REL=#{custRel}
		</if>
		and (uo.AUDIT_STATE='1' or uo.AUDIT_STATE='3'  or uo.AUDIT_STATE like '3`%')
		)
		
		and SHZT = '2'
		<if test="memId!=null">
			and gm.RYID = #{memId}
		</if>
		<if test="custTypes!=null">
			and gm.KHFLDM = #{custTypes}
		</if>
		<if test="custRel!=null">
			and gm.GXLXBH = #{custRel}
		</if>
		<if test="calTimeEndLast!=null">
			and gm.FPRQ &lt;= #{calTimeEndLast}
		</if>
		) gmx on cs.CUST_ID=gmx.KHID
		where
		cs.COST_SX=1
		and cs.CUST_ID is not
		null
		and cs.CUST_SET_ID is null
		<if test="custRel!=null">
			and cs.GX_TYPE=#{custRel}
		</if>
		<if test="calTimeStart!=null and calTimeEnd!=null">
			and to_date(cs.COST_BEGIN_TIME,'YYYYMMDD') &lt;=
			to_date(#{calTimeStart},'YYYYMMDD')
			and to_date(cs.COST_END_TIME,'YYYYMMDD')
			&gt;= to_date(#{calTimeEnd},'YYYYMMDD')
		</if>
		and cs.DELETE_FLAG=1
	</select>

	<!-- 查询客户累计成本 -->
	<select id="SelectCumulativeCost" parameterType="map"
		resultType="java.math.BigDecimal">
		select sum(costed)COSTED
		from T_COST_TOTAL
		<where>
			<if test="memId!=null">
				and MEMBER_ID=#{memId}
			</if>
			<if test="custId!=null">
				and CUST_ID=#{custId}
			</if>
			<if test="objType!=null">
				and OBJ_TYPE = #{objType}
			</if>
			<if test="calTimeStartLast!=null">
				and TOTAL_TIME_START = #{calTimeStartLast}
			</if>
			<if test="calTimeEndLast!=null">
				and TOTAL_TIME_END = #{calTimeEndLast}
			</if>
			<if test="custRel!=null">
				and gx_type = #{custRel}
			</if>
			<if test="costSX!=null">
				and cost_sx = #{costSX}
			</if>
		</where>
		group by cust_id,gx_type,obj_type,cost_sx
	</select>
	
	<!-- 查询人员累计成本 -->
	<select id="SelectCumulativeCostRY" parameterType="map"
		resultType="java.math.BigDecimal">
		select sum(costed)COSTED 
		from T_COST_TOTAL 
		<where>
			<if test="memId!=null">
				and MEMBER_ID=#{memId}
			</if>
			<if test="custType!=null">
				and CUST_SET_ID=#{custType}
			</if>
			<if test="custTypes!=null">
				and CUST_SET_ID = #{custTypes}
			</if>
			<if test="custTypes==null">
				and CUST_SET_ID is null
			</if>
			<if test="custId!=null">
				and CUST_ID=#{custId}
			</if>
			<if test="custIds!=null">
				and CUST_ID in
				<foreach collection="custIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>
			<if test="objType!=null">
				and OBJ_TYPE = #{objType}
			</if>
			<if test="calTimeStartLast!=null">
				and TOTAL_TIME_START = #{calTimeStartLast}
			</if>
			<if test="calTimeEndLast!=null">
				and TOTAL_TIME_END = #{calTimeEndLast}
			</if>
			<if test="custRel!=null">
				and gx_type = #{custRel}
			</if>
			<if test="costSX!=null">
				and cost_sx = #{costSX}
			</if>
		</where>
		group by MEMBER_ID,gx_type,obj_type,cost_sx,cust_set_id
	</select>
	
	<delete id="deleteCumulativeCost" parameterType="map">
		delete from T_COST_TOTAL
		<where>
			<if test="calTimeStart!=null">
				and TOTAL_TIME_START = #{calTimeStart}
			</if>
			<if test="calTimeEnd!=null">
				and TOTAL_TIME_END = #{calTimeEnd}
			</if>
			<if test="memIds!=null">
				and MEMBER_ID in
				<foreach collection="memIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</delete>

	<update id="updateCumulativeCost" parameterType="map">
		update T_COST_TOTAL
		set TOTAL_VALUE=#{totalValue}
		<where>
			<if test="memId!=null">
				and MEMBER_ID=#{memId}
			</if>
			<if test="custType!=null">
				and CUST_SET_ID=#{custType}
			</if>
			<if test="objType!=null">
				and OBJ_TYPE=#{objType}
			</if>
			<if test="custId!=null">
				and CUST_ID=#{custId}
			</if>
			<if test="calTimeStart!=null">
				and TOTAL_TIME_START = #{calTimeStart}
			</if>
			<if test="calTimeEnd!=null">
				and TOTAL_TIME_END = #{calTimeEnd}
			</if>
		</where>
	</update>
	<!-- 根据人员客户查询分成比例 -->
	<select id="selectCostScale" parameterType="map"
		resultType="java.math.BigDecimal">
		select gm.BL_FC
		from T_GXGL_GXMX gm
		<where>
			<if test="custId!=null">
				and gm.KHID = #{custId}
			</if>
			<if test="memId!=null">
				and gm.RYID = #{memId}
			</if>
		</where>
	</select>

	<!-- 根据人员客户分类客户关系查询未设置单户提成的客户 -->
	<select id="selectCustByCondition" resultType="java.lang.String"
		parameterType="map">
		select distinct gm.KHID
		from T_GXGL_GXMX gm
		where
		not EXISTS(
		SELECT uo.ID
		FROM T_XCMODEL_USROBJ uo
		LEFT JOIN T_XCTCMODEL M ON uo.MODEL_ID =
		M.MODEL_ID
		WHERE uo.USROBJ_TYPE = '2' and uo.CUST_ID =to_char(gm.KHID)
		<if test="custRel!=null">
			and uo.CUST_REL=#{custRel}
		</if>
		and (uo.AUDIT_STATE='1' or uo.AUDIT_STATE='3'  or uo.AUDIT_STATE like '3`%')
		)
		and SHZT = '2'
		<if test="memId!=null">
			and gm.RYID = #{memId}
		</if>
		<if test="custType!=null">
			and gm.KHFLDM = #{custType}
		</if>
		<if test="custTypes!=null">
			and gm.KHFLDM = #{custTypes}
		</if>
		<if test="custRel!=null">
			and gm.GXLXBH = #{custRel}
		</if>
		<if test="lastTime!=null">
			and gm.FPRQ &lt;= #{lastTime}
		</if>
	</select>

	<insert id="InsertSalaryResult" parameterType="map">
		insert into
		${tableName}(
		ID,BATCH_ID,ITEM_ID,ITEM_NAME,
		ITEM_VALUE,ITEM_DESC,TARGET_ID,
		ITEM_TYPE,ITEM_STEP,ITEM_MODIFY_FLAG,
		ITEM_MODIFY_OBJ,ITEM_MODIFY_DESC,SUPER_ID,
		ORI_ITEM_VALUE,REC_GEN_TIME,REC_UPD_TIME)
		values(
		#{id},#{batchId},#{itemId},#{itemName},
		#{itemValue},#{itemDesc},#{targetId},
		#{itemType},#{itemStep},#{itemModifyFlag},
		#{itemModifyObj},#{itemModifyDesc},#{superId},
		#{oriItemValue},#{recGenTime},#{recUpdTime}
		)
	</insert>
	<!-- 查询薪酬科目结果 -->
	<select id="selectItemResult" resultType="com.linkstec.lmspcom.newsalary.dto.SalaryResultDto"
		parameterType="map">
		SELECT DISTINCT
		A.ID id,
		A.TARGET_ID targetId,
		A.ITEM_VALUE itemValue,
		A.ITEM_ID itemId,
		NVL(T.SALARY_NAME,A.ITEM_ID) itemName,
		T.SALARY_TYPE itemType,
		A.TARGET_NAME memberName,
		A.TARGET_BUSIDEPNAME orgName,
		A.TARGET_BUSIDEPID orgId,
		A.TARGET_TYPE ptype,
		A.TARGET_LEVEL plevel,
		T.ITEM_LEVEL itemLevel
		FROM
		${tableName} A
		INNER JOIN T_XCITEM T on A.ITEM_ID = T.SALARY_CODE
		INNER JOIN CRM.L_ORGANIZATION_EXPAND C on A.TARGET_BUSIDEPID=C.JGID
		<where>
			A.ITEM_STEP = 1  and exists (select 1 from l_sal_res /*LT*/ where
			target_id = ryid)
			<if test="hcFlag==1">
				and C.jg_type_sub in ('1','4')
			</if>
			<if test="hcFlag==2">
				and C.jg_type_sub=2
			</if>
			<if test="batchId!=null">
				and A.BATCH_ID = #{batchId}
			</if>
			<if test="orgId!=null">
				and A.TARGET_BUSIDEPID = #{orgId}
			</if>
			<if test="orgIdList!=null">
				and A.TARGET_BUSIDEPID IN
				<foreach collection="orgIdList" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>
			<if test="memKey!=null">
				and (A.TARGET_NAME like #{memKey} or A.TARGET_ID like
				#{memKey})
			</if>
			<if test="filterZero!=null">
				and A.ITEM_VALUE &lt;&gt; 0
				and A.ITEM_VALUE IS NOT NULL
			</if>
			<if test="memType!=null">
				and A.TARGET_TYPE = #{memType}
			</if>
		</where>
		ORDER BY A.TARGET_BUSIDEPNAME,A.TARGET_ID,T.ITEM_LEVEL,A.ID
	</select>
	
	<!-- 内部渠道查询薪酬科目结果汇总 -->
	<select id="selectItemResultHz" resultType="Double"
		parameterType="map">
		SELECT 
		 sum(nvl(A.ITEM_VALUE,0)) itemValue
		FROM
		${tableName} A
		INNER JOIN T_XCITEM T on A.ITEM_ID = T.SALARY_CODE
		INNER JOIN CRM.L_ORGANIZATION_EXPAND C on A.TARGET_BUSIDEPID=C.JGID
		<where>
			A.ITEM_STEP = 1  and exists (select 1 from l_sal_res /*LT*/ where
			target_id = ryid)
			<if test="hcFlag==1">
				and C.jg_type_sub in ('1','4')
			</if>
			<if test="hcFlag==2">
				and C.jg_type_sub=2
			</if>
			<if test="batchId!=null">
				and A.BATCH_ID = #{batchId}
			</if>
			<if test="orgId!=null">
				and A.TARGET_BUSIDEPID = #{orgId}
			</if>
			<if test="orgIdList!=null">
				and A.TARGET_BUSIDEPID IN
				<foreach collection="orgIdList" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>
			<if test="memKey!=null">
				and (A.TARGET_NAME like #{memKey} or A.TARGET_ID like
				#{memKey})
			</if>
			<if test="filterZero!=null">
				and A.ITEM_VALUE &lt;&gt; 0
				and A.ITEM_VALUE IS NOT NULL
			</if>
			<if test="memType!=null">
				and A.TARGET_TYPE = #{memType}
			</if>
		</where>
	</select>

	<!-- 查询三险一金 -->
	<select id="selectSXYJByCondition" parameterType="map"
		resultType="com.linkstec.lmspcom.newsalary.dto.SXYJDto">
		SELECT
		C.XM name,
		C.XM||'('||A.MEM_ID||')' memName,
		C.JG_NAME
		orgName,c.CURRENT_TYPE,
		A.ID id,
		A.MEM_ID memId,
		A.UNEMPLOYMENT_VALUE
		unemploymentValue,
		A.PESION_VALUE pesionValue,
		A.MEDICAL_VALUE
		medicalValue,
		A.HOUSEFUND_VALUE houseFundValue,
		(A.UNEMPLOYMENT_VALUE+A.PESION_VALUE+A.MEDICAL_VALUE+A.HOUSEFUND_VALUE)
		totalValue,
		A.RECODE_TIME recodeTime
		FROM
		T_XC_SXYJ /*LT*/ A
		LEFT JOIN (
		SELECT
		DISTINCT
		jjr.RYID,JJR.XM,rel.JG_NAME,rel.JGID,jjr.CURRENT_TYPE
		from
		T_EHR_JJR_JBXX jjr
		INNER JOIN
		L_ORGANIZATION_EXPAND rel on
		jjr.JGID=rel.JGID
		where 1=1
		) C ON
		A.MEM_ID = C.RYID
		<where>
			<if test="memKey!=null">
				and (C.XM like #{memKey} or A.MEM_ID like
				#{memKey})
			</if>
			<if test="orgKey!=null">
				and (C.JYDY_NAME like #{orgKey} or C.JYDY_ID like
				#{orgKey})
			</if>
			<if test="memId!=null">
				and A.MEM_ID = #{memId}
			</if>
		</where>
		order by RECODE_TIME desc
	</select>

	<select id="selectSXYJByConditionTotal" parameterType="map"
		resultType="com.linkstec.lmspcom.newsalary.dto.SXYJDto">
		SELECT
		SUM(A.UNEMPLOYMENT_VALUE)
		unemploymentValue,
		SUM(A.PESION_VALUE)
		pesionValue,
		SUM(A.MEDICAL_VALUE) medicalValue,
		SUM(A.HOUSEFUND_VALUE)
		houseFundValue,
		SUM(A.UNEMPLOYMENT_VALUE+A.PESION_VALUE+A.MEDICAL_VALUE+A.HOUSEFUND_VALUE)
		totalValue
		FROM
		T_XC_SXYJ /*LT*/ A
		LEFT JOIN (
			SELECT
		DISTINCT
		jjr.RYID,JJR.XM,rel.JG_NAME,rel.JGID,jjr.CURRENT_TYPE
		from
		T_EHR_JJR_JBXX jjr
		INNER JOIN
		L_ORGANIZATION_EXPAND rel on
		jjr.JGID=rel.JGID
		where 1=1
		) C ON
		A.MEM_ID = C.RYID
		<where>
			<if test="memKey!=null">
				and (C.XM like #{memKey} or A.MEM_ID like
				#{memKey})
			</if>
			<if test="orgKey!=null">
				and (C.JYDY_NAME like #{orgKey} or C.JYDY_ID like
				#{orgKey})
			</if>
			<if test="memId!=null">
				and A.MEM_ID = #{memId}
			</if>
		</where>
		order by RECODE_TIME desc
	</select>

	<!-- 查询基本工资 -->
	<select id="selectBasePayByCondition" parameterType="map"
		resultType="com.linkstec.lmspcom.newsalary.dto.BasePayDto">
		SELECT
		M.XM name,
		M.XM||'('||A.MEM_ID||')' memName,
		A.ID id,
		A.MEM_ID
		memId,
		A.PAY_VALUE payValue,
		A.BUSI_DEPID busiDepId,
		A.MEM_TYPE memType,
		A.MEM_LEVEL memLevel,a.DEPTYPE
		FROM
		T_XC_BASEPAY A
		LEFT JOIN
		T_EHR_JJR_JBXX M ON
		A.MEM_ID = M.RYID
		<where>
			<if test="memId!=null">
				and A.MEM_ID = #{memId}
			</if>

			<if test="memId==null">
				and A.MEM_ID is null
			</if>
			<if test="useType!=null">
				and (A.MEM_TYPE = #{useType} or
				A.MEM_TYPE is null)
			</if>

			<if test="useLevel!=null">
				and (A.MEM_LEVEL = #{useLevel} or
				A.MEM_LEVEL is null)
			</if>

			<if test="depIds!=null">
				and (A.BUSI_DEPID IN
				<foreach collection="depIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
				 or a.BUSI_DEPID is null)
			</if>
			<if test="depType!=null">
				and a.DEPTYPE =#{depType}			
			</if>
		</where>
		order by A.RECODE_TIME desc
	</select>


	<select id="selectItemDetailBySuperId"
		parameterType="com.linkstec.lmspcom.newsalary.dto.FetchSalaryItemDetailInDto"
		resultType="com.linkstec.lmspcom.newsalary.dto.FetchSalaryItemDetailDto">
		SELECT distinct A.ID id,A.ITEM_ID itemId,A.ITEM_NAME
		itemName,A.ITEM_VALUE itemValue,
		A.ITEM_DESC itemDesc,A.ITEM_TYPE
		itemType,A.ITEM_STEP itemStep,
		A.ITEM_MODIFY_DESC modelDesc,
		<if test="type==4">
			C.KHXM||'('||C.KHID||')' targetName,
		</if>
		<if test="type==9 || type==10">
			D.XM targetName,
		</if>
		A.TARGET_ID targetId
		FROM ${tableName} A
		<if test="type==4">
			LEFT JOIN (select k.KHID,k.KHXM from T_KH_XX k)C ON C.KHID
			= A.TARGET_ID
		</if>
		<if test="type==9 || type==10">
			LEFT JOIN T_EHR_JJR_JBXX D ON D.RYID = A.TARGET_ID
		</if>
		where
		A.SUPER_ID = #{superId}
		and A.ITEM_VALUE >0
		<if test="itemValueType!=null">
			and A.ITEM_TYPE=#{itemValueType}
		</if>
		<if test="type==9 || type==10">
			order by A.TARGET_ID
		</if>
		<if test="type!=9 and  type!=10">
			order by SUBSTR( A.ITEM_MODIFY_DESC ,INSTR( A.ITEM_MODIFY_DESC ,'custType',1,1) +11 , 2) DESC, A.ITEM_ID
		</if>
	</select>

	<!-- 查询所有团队和团队负责人 -->
<!-- 	<select id="selectTeamLeader" resultType="map">
		SELECT distinct FZR_ID
		"memId",JYDY_ID "teamId" from T_JYDY_XX where JYDY_CJ = 2
		and FZR_ID is
		NOT NULL
	</select> -->

	<!-- 查询某人负责团队下的所有人员 -->
	<!-- <select id="selectTeamAllName" resultType="java.lang.Long"
		parameterType="map">
		select MEMBER_ID from L_MEMBER_TD_REL,T_EHR_JJR_JBXX where MEMBER_ID = ryid and JYDY_ID IN
		(SELECT JYDY_ID
		from T_JYDY_XX where JYDY_CJ = 2 and FZR_ID = #{memId})
		<if test="notInFlag!=null">
			AND MEMBER_ID &lt;&gt; #{memId}
		</if>
		and nvl(rzrq,0) &lt; #{calTime}
		and (SUBSTR(lzrq, 1, 6)=#{calTime} or SUBSTR(lzrq, 1, 6) is null)
	</select> -->

	<select id="selectTabelCol"
		resultType="com.linkstec.lmspcom.newsalary.dto.FetchTableColNameDto"
		parameterType="com.linkstec.lmspcom.newsalary.dto.FetchTableColNameInDto">
		SELECT
		column_name colName,
		column_name coldesc
		FROM
		user_tab_columns
		WHERE
		data_type='NUMBER'
		<if test="tableNameOne!=null">
			AND table_name = #{tableNameOne}
		</if>
		<if test="tableNameTwo!=null">
			AND table_name = #{tableNameTwo}
		</if>
	</select>

	<!-- 根据客户关系查询客户分类 -->
	<select id="selectCustTypeByRel" parameterType="map" resultType="map">
		select KHFLDM "typeId",KHFLMC "typeName" from T_CUST_TYPE
		<where>
			<if test="custTypeNum!=null">
				and KHFLDM = #{custTypeNum}
			</if>
		</where>
	</select>

	<!-- 根据客户关系查询客户分类 -->
	<select id="selectCustTypeDMByRel" parameterType="map"
		resultType="java.lang.String">
		select KHFLDM from T_CUST_TYPE
		<where>
			<if test="custRel!=null">
				and KHLX = #{custRel}
			</if>
		</where>
	</select>

	<!-- 根据客户分类ID查询客户分类 -->
	<select id="selectCustTypeByNum" resultType="java.lang.String"
		parameterType="map">
		select KHFLMC from T_CUST_TYPE
		where KHFLDM in
		<foreach collection="custNums" open="(" separator="," close=")"
			item="item">
			#{item}
		</foreach>
	</select>

	<!-- 根据科目模版查询客户关系 -->
	<select id="selectCustRelBySlaryModel"
		parameterType="com.linkstec.lmspcom.newsalary.dto.QueryCustTypeByCommissionInDto"
		resultType="map">
		select A.CUST_REL "custRel"
		from T_XCTCGSDY A LEFT JOIN
		T_XCTCMODEL B on A."ID" = B.MODEL_FORMUAL_ID
		where B.MODEL_ID = #{id}
	</select>

	<!-- 调整清算值 -->
	<update id="updateSalaryItemValue"
		parameterType="com.linkstec.lmspcom.newsalary.dto.ModifySalaryItemValueInDto">
		update ${tableName}
		set
		ITEM_VALUE=#{newValue},ITEM_MODIFY_FLAG=1,ITEM_MODIFY_OBJ=#{memId},ITEM_MODIFY_DESC=#{desc}
		where ID = #{id}
	</update>

	<!-- 查询科目公式中指标 -->
	<select id="findItemIndexValue" resultType="java.math.BigDecimal"
		parameterType="map">
		select SUM(${colName}) from ${tableName}
		<where>
			<if test="initDate!=null">
				and init_date=#{initDate}
			</if>
			<if test="memId!=null">
				and RYID=#{memId}
			</if>
			<if test="custId!=null">
				and KHID=#{custId}
			</if>
			<if test="busiType!=null">
				and BUSINESS_FLAG=#{busiType}
			</if>
			<if test="custRel!=null">
				and trim(GXLXBH)=#{custRel}
			</if>
			<if test="custType!=null">
				and FL_ID=#{custType}
			</if>
			<if test="teamId!=null">
				and TD_ID=#{teamId}
			</if>
			<if test="jgId!=null">
				and JGID=#{jgId}
			</if>
			<if test="depId!=null">
				and BRANCH_NO=#{depId}
			</if>
			<if test="depIds!=null">
				and BRANCH_NO in
				<foreach collection="depIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>
			<if test="cpCode!=null">
				and CPNBDM=#{cpCode}
			</if>
		</where>
	</select>

	<!-- 查询科目公式中指标值和业务类型值 -->
	<select id="findItemIndexBusiFlagValue" resultType="map"
		parameterType="map">
		select A.${colName} "value",A.BUSINESS_FLAG "busiFlag"
		<if test="custIndexFlag==1">
			,A.KHXM "khxm",A.KHID "khid"
		</if>
		from ${tableName} A
		<where>
			<if test="initDate!=null">
				and A.init_date=#{initDate}
			</if>
			<if test="memId!=null">
				and A.RYID=#{memId}
			</if>
			<if test="custId!=null">
				and A.KHID=#{custId}
			</if>
			<if test="custRel!=null">
				and trim(A.GXLXBH)=#{custRel}
			</if>
			<if test="custType!=null">
				and A.FL_ID=#{custType}
			</if>
			<if test="teamId!=null">
				and A.TD_ID=#{teamId}
			</if>
			<if test="jgId!=null">
				and A.JGID=#{jgId}
			</if>
			<if test="depId!=null">
				and A.BRANCH_NO=#{depId}
			</if>
			<if test="busiTypes!=null">
				and A.BUSINESS_FLAG in
				<foreach collection="busiTypes" open="(" separator=","
					close=")" item="item">
					#{item}
				</foreach>
			</if>
			<if test="depIds!=null">
				and A.BRANCH_NO in
				<foreach collection="depIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>
			<if test="cpCode!=null">
				and A.CPNBDM=#{cpCode}
			</if>
		</where>
	</select>

	<!-- 查询客户累计指标 -->
	<select id="findAddIndexValue" resultType="java.math.BigDecimal"
		parameterType="map">
		select sum(${colName}) from ${tableName} A
		<where>
			<if test="initDate!=null">
				and A.init_Date=#{initDate}
			</if>
			<if test="memId!=null">
				and A.RYID=#{memId}
			</if>
			<if test="busiType!=null">
				and A.BUSINESS_FLAG=#{busiType}
			</if>
			<if test="busiTypes!=null">
				and A.BUSINESS_FLAG in
				<foreach collection="busiTypes" open="(" separator=","
					close=")" item="item">
					#{item}
				</foreach>
			</if>
			<if test="custRel!=null">
				and A.GXLXBH=#{custRel}
			</if>
			<if test="custId!=null">
				and A.KHID=#{custId}
			</if>
			<if test="flag!=null">
				and not EXISTS(SELECT distinct uo.CUST_ID custId FROM
				T_XCMODEL_USROBJ
				uo left JOIN T_XCTCMODEL M ON uo.MODEL_ID =
				M.MODEL_ID left JOIN
				T_XCTCGSDY ms ON M.MODEL_FORMUAL_ID = ms.ID
				WHERE A.KHID=uo.CUST_ID
				and uo.USER_ID=#{memId} and uo.USROBJ_TYPE ='2'
				  <if test="custRel!=null">
				     and uo.CUST_REL=#{custRel}
			      </if>
				and (uo.AUDIT_STATE='1' or uo.AUDIT_STATE='3'  or uo.AUDIT_STATE like '3`%')
				)
			</if>
			<if test="custIds!=null">
				and A.KHID in
				<foreach collection="custIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>
			<if test="custTypes!=null || teamCustTypes!=null">
				and EXISTS(
				select M.KHID from(
				select gm.KHID from T_GXGL_GXMX gm
				where gm.SHZT=2
				<if test="memId!=null">
					and gm.RYID = #{memId}
				</if>
				<if test="custRel!=null">
					and gm.GXLXBH=#{custRel}
				</if>
				<if test="custTypes!=null">
					AND gm.KHFLDM =#{custTypes}
				</if>
				<if test="teamCustTypes!=null">
					AND gm.KHFLDM in
					<foreach collection="teamCustTypes" open="(" separator=","
						close=")" item="item">
						#{item}
					</foreach>
				</if>


				<if test="lastTime!=null">
					and gm.FPRQ &lt;= #{lastTime}
				</if>
				UNION ALL
				SELECT DISTINCT gmh.KHID FROM T_GXGL_GXMX_HIS gmh
				where
				<if test="custTypes!=null">
					gmh.KHFLDM = #{custTypes}
				</if>
				<if test="teamCustTypes!=null">
					gmh.KHFLDM in
					<foreach collection="teamCustTypes" open="(" separator=","
						close=")" item="item">
						#{item}
					</foreach>
				</if>

				<if test="memId!=null">
					and gmh.RYID=#{memId}
				</if>
				<if test="custRel!=null">
					and gmh.GXLXBH=#{custRel}
				</if>
				<if test="firstTime!=null">
					and gmh.REC_GEN_TIME &gt;= #{firstTime}
				</if>
				)M
				where M.KHID=A.KHID
				)
			</if>
		</where>

	</select>

	<!-- 查询客户累计指标 明细 -->
	<select id="findAddIndexDetail" resultType="map" parameterType="map">
		select ${colName} "itemValue",A.KHXM "khxm",A.KHID "khid"
		<if test="busiTypes!=null">
			,A.BUSINESS_FLAG "busiType"
		</if>
		from ${tableName} A
		<where>
			<if test="initDate!=null">
				and A.init_Date=#{initDate}
			</if>
			<if test="memId!=null">
				and A.RYID=#{memId}
			</if>
			<if test="busiType!=null">
				and A.BUSINESS_FLAG=#{busiType}
			</if>
			<if test="busiTypes!=null">
				and A.BUSINESS_FLAG in
				<foreach collection="busiTypes" open="(" separator=","
					close=")" item="item">
					#{item}
				</foreach>
			</if>
			<if test="custId!=null">
				and A.KHID=#{custId}
			</if>
			<if test="custRel!=null">
				and A.GXLXBH=#{custRel}
			</if>
			<if test="flag!=null">
				and not EXISTS(SELECT distinct uo.CUST_ID custId FROM
				T_XCMODEL_USROBJ uo
				WHERE A.KHID=uo.CUST_ID
				and uo.USER_ID=#{memId}
				and uo.USROBJ_TYPE ='2'
				<if test="custRel!=null">
				     and uo.CUST_REL=#{custRel}
			     </if>
				and (uo.AUDIT_STATE='1' or uo.AUDIT_STATE='3'  or uo.AUDIT_STATE like '3`%')
				)
			</if>
			<if test="custIds!=null">
				and A.KHID in
				<foreach collection="custIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>

		</where>
	</select>
	
	<select id="selectCustInfos" resultType="java.lang.Long" parameterType="map">
	         select M.KHID from(
				select distinct gm.KHID from
				T_GXGL_GXMX gm
				where 
<!-- 				gm.SHZT=2 -->
				  (gm.gxzt &lt;&gt; 1 or (gm.gxzt = 1 and gm.shzt = 2)) 
				<if test="memId!=null">
					and gm.RYID = #{memId}
				</if>
				<if test="custRel!=null">
					and gm.GXLXBH=#{custRel}
				</if>
				<if test="custTypes!=null">
					AND gm.KHFLDM = #{custTypes}
				</if>
				<if test="teamCustTypes!=null">
					AND gm.KHFLDM in
					<foreach collection="teamCustTypes" open="(" separator=","
						close=")" item="item">
						#{item}
					</foreach>
				</if>

				<if test="lastTime!=null">
					and gm.FPRQ &lt;= #{lastTime}
				</if>
				UNION ALL
				SELECT DISTINCT gmh.KHID FROM T_GXGL_GXMX_HIS gmh
				where
				<if test="custTypes!=null">
					gmh.KHFLDM =#{custTypes}
				</if>
				<if test="teamCustTypes!=null">
					gmh.KHFLDM in
					<foreach collection="teamCustTypes" open="(" separator=","
						close=")" item="item">
						#{item}
					</foreach>
				</if>
				<if test="memId!=null">
					and gmh.RYID=#{memId}
				</if>
				<if test="custRel!=null">
					and gmh.GXLXBH=#{custRel}
				</if>
				<if test="firstTime!=null">
					and gmh.REC_GEN_TIME &gt;= #{firstTime}
				</if>
				)M
	</select>

	<!-- 查询提成中指标 -->
	<select id="findCommissionIndexValue" resultType="java.math.BigDecimal"
		parameterType="map">
		select SUM(${colName}) from ${tableName} A
		<where>
			<if test="initDate!=null">
				and A.init_Date=#{initDate}
			</if>
			<if test="memId!=null">
				and A.RYID=#{memId}
			</if>
			<if test="custId!=null">
				and A.KHID=#{custId}
			</if>
			<if test="custTypes!=null || teamCustTypes!=null">
				and EXISTS(
				select M.KHID from(
				select distinct gm.KHID from
				T_GXGL_GXMX gm
				where gm.SHZT=2
				<if test="memId!=null">
					and gm.RYID = #{memId}
				</if>
				<if test="custRel!=null">
					and gm.GXLXBH=#{custRel}
				</if>
				<if test="custTypes!=null">
					AND gm.KHFLDM = #{custTypes}
				</if>
				<if test="teamCustTypes!=null">
					AND gm.KHFLDM in
					<foreach collection="teamCustTypes" open="(" separator=","
						close=")" item="item">
						#{item}
					</foreach>
				</if>
				<if test="lastTime!=null">
					and gm.FPRQ &lt;= #{lastTime}
				</if>
				UNION ALL
				SELECT DISTINCT gmh.KHID FROM T_GXGL_GXMX_HIS gmh
				where
				<if test="custTypes!=null">
					gmh.KHFLDM = #{custTypes}
				</if>
				<if test="teamCustTypes!=null">
					gmh.KHFLDM in
					<foreach collection="teamCustTypes" open="(" separator=","
						close=")" item="item">
						#{item}
					</foreach>
				</if>

				<if test="memId!=null">
					and gmh.RYID=#{memId}
				</if>
				<if test="custRel!=null">
					and gmh.GXLXBH=#{custRel}
				</if>
				<if test="firstTime!=null">
					and gmh.REC_GEN_TIME &gt;= #{firstTime}
				</if>
				)M
				where M.KHID=A.KHID
				)
			</if>
			<if test="busiType!=null">
				and A.BUSINESS_FLAG=#{busiType}
			</if>
			<if test="custRel!=null">
				and trim(A.GXLXBH)=#{custRel}
			</if>
			<if test="custType!=null">
				and A.FL_ID=#{custType}
			</if>
			<if test="teamId!=null">
				and A.TD_ID=#{teamId}
			</if>
			<if test="jgId!=null">
				and A.JGID=#{jgId}
			</if>
			<if test="depId!=null">
				and A.BRANCH_NO=#{depId}
			</if>
			<if test="depIds!=null">
				and A.BRANCH_NO in
				<foreach collection="depIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>
			<if test="cpCode!=null">
				and A.CPNBDM=#{cpCode}
			</if>
		</where>

	</select>

	<select id="findCommissionIndexBusiValue" resultType="map"
		parameterType="map">
		select ${colName} "value",A.BUSINESS_FLAG "busiFlag" 
		<if test="custTypes!=null ||teamCustTypes!=null || custIndexFlag==1">
		    ,A.KHID "khid",A.KHXM "khxm"
		</if>
		from ${tableName} A
		<where>
			<if test="initDate!=null">
				and A.init_Date=#{initDate}
			</if>
			<if test="memId!=null">
				and A.RYID=#{memId}
			</if>
			<if test="custId!=null">
				and A.KHID=#{custId}
			</if>
			<if test="busiTypes!=null">
				and A.BUSINESS_FLAG in
				<foreach collection="busiTypes" open="(" separator=","
					close=")" item="item">
					#{item}
				</foreach>
			</if>
			<if test="custRel!=null">
				and trim(A.GXLXBH)=#{custRel}
			</if>
			<if test="custType!=null">
				and A.FL_ID=#{custType}
			</if>
			<if test="teamId!=null">
				and A.TD_ID=#{teamId}
			</if>
			<if test="jgId!=null">
				and A.JGID=#{jgId}
			</if>
			<if test="depId!=null">
				and A.BRANCH_NO=#{depId}
			</if>
			<if test="depIds!=null">
				and A.BRANCH_NO in
				<foreach collection="depIds" open="(" separator="," close=")"
					item="item">
					#{item}
				</foreach>
			</if>
			<if test="cpCode!=null">
				and A.CPNBDM=#{cpCode}
			</if>
		</where>

	</select>


	<!-- 根据审核状态 -->
	<update id="updateModelAuditState" parameterType="map">
		update
		T_XCMODEL_USROBJ
		set
		AUDIT_STATE=#{newState}
		where AUDIT_STATE =
		#{oldState}
	</update>

	<!-- 查询可选累计指标 -->
	<select id="selectCanChooseAddIndex" parameterType="map"
		resultType="map">
		select ZB_CODE "id",ZB_NAME "name" from T_XCZB WHERE
		ZB_TYPE = #{type}
	</select>

	<!-- 查询岗位中的所有经纪人 -->
	<select id="selectMemByPost" parameterType="map" resultType="java.lang.Long">
		select RYID from T_EHR_JJR_JBXX where CURRENT_TYPE=#{memType} and nvl(RZRQ,0) &lt;= #{calTimeEnd}
		and (SUBSTR(lzrq, 1, 8)>=#{calTimeEnd} or SUBSTR(lzrq, 1, 8) is null)
	</select>

	<!-- 查询适用人适用的提成模版 -->
	<select id="selectUsrModelByCondition"
		parameterType="com.linkstec.lmspcom.newsalary.dto.AddCommisssionModelCheckInDto"
		resultType="map">
		select distinct a.ID "id",CUST_TYPE "custType",c.COMMISSION_EXP_TYPE "commissionExpType" 
			from T_XCMODEL_USROBJ a,T_XCTCMODEL b,T_XCTCGSDY c 
		<where>
		    a.MODEL_ID = b.MODEL_ID AND b.MODEL_FORMUAL_ID= c."ID"
		    and (AUDIT_STATE!='4' and AUDIT_STATE not like '4`%')
			<if test="type==1">
				<if test="custId==null">
					and CUST_ID is null
				</if>
				<if test="memId!=null">
					and USER_ID = #{memId}
				</if>
				<if test="memId==null">
					and USER_ID is NULL
					
					<if test="depId!=null">
						and ORG_ID = #{depId}
					</if>
					<if test="depId==null">
						and ORG_ID is null
					</if>
					<if test="memType!=null">
						and USER_TYPE=#{memType}
					</if>
					<if test="memType==null">
						and USER_TYPE is null
					</if>
					<if test="memLevel!=null">
						and USER_LEVEL=#{memLevel}
					</if>
					<if test="memLevel==null">
						and USER_LEVEL is null
					</if>
					<if test="depType!=null">
						and USER_DEPTYPE = #{depType}
					</if>
					<if test="depType==null">
						and USER_DEPTYPE is null
					</if>
				</if>
			</if>
			<if test="type==2">
				<if test="memId!=null">
					and USER_ID=#{memId}
				</if>
				<if test="memId==null">
					and USER_ID is null
				</if>
				<if test="custId!=null">
					and CUST_ID = #{custId}
				</if>
				<if test="custId==null">
					and CUST_ID is null
				</if>
				<if test="custRel!=null">
					and a.CUST_REL = #{custRel}
				</if>
				<if test="custRel==null">
					and a.CUST_REL is NULL
				</if>
			</if>
			<if test="modelFormualId!=null">
				and b.model_formual_id = #{modelFormualId}
			</if>
			<if test="commissionType!=null">
				AND c.COMMISSION_TYPE = #{commissionType}
			</if>	
			<if test="commissionExpType!=null">
				AND c.COMMISSION_EXP_TYPE = #{commissionExpType}
			</if>	
			<if test="commissionExpType==null">
			    AND c.COMMISSION_EXP_TYPE != 3
			</if>
			
		</where>
	</select>
	<!-- 查询客户分类下的客户 -->
	<select id="selectCustNumByType" parameterType="map" resultType="java.lang.Long">
		select COUNT(M.KHID) from(
		select distinct gm.KHID from T_GXGL_GXMX gm
		where gm.SHZT=2
		<if test="memId!=null">
			and gm.RYID = #{memId}
		</if>
		<if test="custRel!=null">
			and gm.GXLXBH=#{custRel}
		</if>
		AND gm.KHFLDM = #{custTypes}
		<if test="lastTime!=null">
			and gm.FPRQ &lt;= #{lastTime}
		</if>
		UNION ALL
		SELECT DISTINCT gmh.KHID FROM T_GXGL_GXMX_HIS gmh
		where
		gmh.KHFLDM = #{custTypes}
		<if test="memId!=null">
			and gmh.RYID=#{memId}
		</if>
		<if test="custRel!=null">
			and gmh.GXLXBH=#{custRel}
		</if>
		<if test="firstTime!=null">
			and gmh.REC_GEN_TIME &gt;= #{firstTime}
		</if>
		)M
	</select>
	
	<delete id="delInqFlow" parameterType="map">
		delete from T_XC_INLIQUIDATION_FLOW
		where BATCH_ID in
		<foreach collection="batchIds" open="(" separator="," close=")"
			item="item">
			#{item}
		</foreach>
	</delete>
	
	<select id="selInqFlow" resultType="java.lang.String" parameterType="map">
		select BATCH_ID from T_XC_INLIQUIDATION_FLOW
		where 
		INLIQUIDATION_STATE &lt;&gt; '1'
		and BATCH_ID in
		<foreach collection="batchIds" open="(" separator="," close=")"
			item="item">
			#{item}
		</foreach>
	</select>

	<delete id="delResult" parameterType="map">
		delete from ${tableName}
		where BATCH_ID in
		<foreach collection="batchIds" open="(" separator="," close=")"
			item="item">
			#{item}
		</foreach>
	</delete>

	<insert id="logCal" parameterType="map">
		insert into ${tableName}(
		rec_id,
		batch_id,
		try_time,
		log_type,
		log_cont,
		exe_user_id,
		target_id,
		group_id,
		ind_id,
		start_time,
		end_time,
		exe_result,
		log_error)
		values(
		#{id},
		#{batchId},
		#{tryTime},
		#{logType},
		#{content},
		#{exeUserId},
		#{targetId},
		#{groupId},
		#{indId},
		#{startTime},
		#{endTime},
		#{result},
		#{error}
		)
	</insert>
	<select id="selectErrorLog" parameterType="map"
		resultType="com.linkstec.lmspcom.newsalary.dto.FetchErrorLogInfoDto">
		select start_time startTime,exe_user_id exeUserId,
		target_id
		targetId,batch_id batchId,log_cont logCont,log_error logError from
		${tableName}
		<where>
			<if test="batchId!=null">
				batch_id like #{batchId}
			</if>
		</where>
	</select>

	<!-- 查询清算人员信息 -->
	<select id="selectInliQInfo" resultType="com.linkstec.lmspcom.newsalary.dto.InliQInfoDto"
		parameterType="map">
		SELECT DISTINCT jjr.RYID ryid,JJR.XM xm,jjr.CURRENT_TYPE pType,
		jjr.CURRENT_PLEVEL plevel,jjr.JGID busiDepId,
		REL.JG_NAME
		busiDepName
		from T_EHR_JJR_JBXX_M jjr
		INNER JOIN L_ORGANIZATION_EXPAND rel
		on
		jjr.JGID=rel.JGID
		where
		1=1
		and rel.jg_type &lt;&gt; 3
<!-- 		清算范围，上线渠道 -->
		and rel.jg_status = 1
		<if test="jgType!=null">
		and rel.JG_TYPE != #{jgType}</if>
		and nvl(JJR.RZRQ,0) &lt;= #{calTimeEnd}
		and (SUBSTR(lzrq, 1, 8)>#{calTimeEnd} or (SUBSTR(lzrq, 1, 8) is null and ygztid &lt;&gt; '2'))
	<!-- 剔除网络经纪人 -->
		and jjr.current_type &lt;&gt; '13'
		<if test="orgIds!=null">
			and jjr.JGID IN
			<foreach collection="orgIds" open="(" separator="," close=")"
				item="item">
				#{item}
			</foreach>
		</if>
		<if test="ryids!=null">
			and jjr.RYID in
			<foreach collection="ryids" open="(" separator="," close=")"
				item="item">
				#{item}
			</foreach>
		</if>
		and NOT EXISTS(select js.JYDY from T_XC_JS js where js.YF_START >=#{calTimeStart}
		AND JS.YF_END &lt;=#{calTimeEnd} 
		and jjr.jgid=js.JYDY and (fhzt=1 or fhzt=0))
		<!-- 当月的数据 -->
		and jjr.END_TIME >=#{calTimeStart}  AND jjr.END_TIME &lt;=#{calTimeEnd} 
	</select>

	<select id="selectInAllDepInq" resultType="java.lang.String"
		parameterType="map">
		SELECT BATCH_ID
		FROM T_XC_INLIQUIDATION_FLOW
		WHERE
		(
		ORG_ID=0
		<if test="orgId!=null">
			or ORG_ID = #{orgId}
		</if>
		)
<!-- 		<if test="calTimeStart!=null"> -->
<!-- 			AND CAL_TIME_START >= #{calTimeStart} -->
<!-- 		</if> -->
		
<!-- 		<if test="calTimeEnd!=null"> -->
<!-- 			AND CAL_TIME_END &lt;= #{calTimeEnd} -->
<!-- 		</if> -->
		AND INLIQUIDATION_STATE = '1'
	</select>

	<!-- 查询所有未结算的经营单元 -->
	<select id="selectAllNotJSJYDY" resultType="map" parameterType="map">
		select jdxx.JGID "busiDepId",
		jdxx.JG_NAME "busiDepName",jdxx.JG_TYPE "jgType" from
		L_ORGANIZATION_EXPAND jdxx
		where 1 = 1
		and jdxx.jg_type &lt;&gt; 3
		and jdxx.jg_status = 1
		<if test="depId!=null">
			and jdxx.JGID = #{depId}
		</if>
		and NOT EXISTS(select js.JYDY from T_XC_JS js where js.YF_START >=#{calTimeStart}
		AND JS.YF_END &lt;=#{calTimeEnd} 
		AND JS.JYDY = jdxx.JGID and (fhzt=1 or fhzt=0)) 
<!-- 		<if test="jgType!=null"> -->
<!-- 		and jdxx.JG_TYPE != #{jgType}</if> -->
	</select>

	<select id="selectAllDepInq" resultType="java.lang.String"
		parameterType="map">
		SELECT BATCH_ID
		FROM T_XC_INLIQUIDATION_FLOW
		where 1=1
		<if test="calType!=null" >
			and cal_type = #{calType}
		</if>
		<if test="orgId!=null">
			AND ORG_ID = #{orgId}
		</if>
		<if test="calTimeStart!=null">
			AND CAL_TIME_START = #{calTimeStart}
		</if>
		<if test="calTimeEnd!=null">
			AND CAL_TIME_END = #{calTimeEnd}
		</if>
		AND (INLIQUIDATION_STATE = '2' or INLIQUIDATION_STATE = '3')
	</select>
	
	<delete id="delResultFlow" parameterType="map">
		delete from T_XC_INLIQUIDATION_FLOW
		where BATCH_ID in
		<foreach collection="batchIds" open="(" separator="," close=")"
			item="item">
			#{item}
		</foreach>
	</delete>
	
<!-- 	查询经纪人清算月推荐的所有人 -->
<select id="selectAllTJR" resultType="java.lang.Long" parameterType="map">
    select RYID 
    FROM RES_SALARY_MEMB_ZDY 
    where RYID_TJR=#{tjrId}
    and  INIT_DATE = #{calTimeEnd}
</select>
<select id="selectMemCustCommissionItem" resultType="map">
    SELECT
	SALARY_CODE "itemId",COMMISSON_TYPE "commissionType"
    FROM T_XCITEM
    WHERE
	SALARY_TYPE = '3'
    AND COMMISSON_TYPE IN (
	SELECT COMMISSION_TYPE
	FROM T_XCTCGSDY
	WHERE COMMISSION_EXP_TYPE = '4'
   )
</select>

<select id="getFlowByBatchId" parameterType="map" resultType="java.lang.Long">
	select count(BATCH_ID) from T_XC_INLIQUIDATION_FLOW where BATCH_ID = #{batchId}
</select>
<select id="getLastJsInfoByJgid" parameterType="map" resultType="com.linkstec.lmspcom.salary.po.TXcJs">
SELECT * FROM T_XC_JS WHERE JYDY = #{jgId} and fhzt= 1 and YF_END &lt;= #{calTimeStart} ORDER BY FH_TIME DESC
</select>
<select id="selectLastCalTime" parameterType="map" resultType="com.linkstec.lmspcom.newsalary.po.TXcInliquidationFlow">
	SELECT * FROM T_XC_INLIQUIDATION_FLOW WHERE CAL_TIME_END &lt; #{calTimeStart} AND ORG_ID = #{jgId} and
 INLIQUIDATION_STATE = 2 order by cal_time_end desc
</select>
<select id="selectCalFlow" parameterType="map" resultType="map">
	SELECT
	"mt".REC_GEN_TIME "mt_80811",
	"mt".REC_UPD_TIME "mt_80812",
	"mt".BATCH_ID "mt_80813",
	"mt".CAL_TIME_START "mt_80814",
	"mt".ORG_ID
	"mt_80815",
	"mt".ORG_NAME "mt_80816",
	"mt".INLIQUIDATION_STATE
	"mt_80817",
	"mt".CAL_TIME "mt_80818",
	"mt".CAL_MEM_ID "mt_80819",
	"mt".CAL_MEM_NAME "mt_80820",
	"mt".CAL_TIME_END "mt_81534",
	"mt".CAL_TYPE "mt_81421"
	FROM
	T_XC_INLIQUIDATION_FLOW
	"mt"
	WHERE
	("mt".CAL_TYPE &lt;&gt; 2)
	<if test="inliqState!=null">
		and "mt".INLIQUIDATION_STATE = #{inliqState}
	</if>
	<if test="jgid!=null">
		AND "mt".ORG_ID = #{jgid}
	</if>
	<if test="calTimeStart!=null">
		AND "mt".CAL_TIME_START = #{calTimeStart}
	</if>
	<if test="calTimeEnd!=null">
		AND "mt".CAL_TIME_END = #{calTimeEnd}
	</if>
	ORDER BY
	"mt_80818" DESC,
	"mt_80811" DESC,
	"mt_80812" DESC
</select>
<select id="selectCountByBatchId" parameterType="java.lang.String" resultType="int">
	SELECT
	"COUNT" (1)
	FROM
	L_SAL_RES_OUTER
	WHERE
	BATCH_ID = #{batchId}
</select>
</mapper>