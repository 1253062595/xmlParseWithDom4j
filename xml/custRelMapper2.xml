<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.linkstec.crm.custRelation.mapper.custRelMapper2">
	<!-- 查询客户首次购买时间 -->
	<select id="selectFirstTradeById" parameterType="java.lang.Long"
		resultType="map">
		select c.first_trade_date from jhdc.clientinfox c where
		c.client_id =#{khid}
	</select>


	<!-- 补挂流程一览 -->

	<select id="selectGXGLBGInfo" parameterType="map" resultType="map">
		select a.*,
		(select JG_NAME from L_ORGANIZATION_EXPAND where JGID = a.branch_no)
		"orgname",
		(select JG_NAME from L_ORGANIZATION_EXPAND where JGID = a.jgid) "ryjgname"
		from (
		select t.khid ,j.branch_no,t.ryid,e.jgid ,t.ryxm,t.khxm
		,t.gtsj,t.status,to_char(t.rec_gen_time,'yyyyMMdd') beginDate,t.ins_id
		,t.bz,t.fprq
		from t_gxgl_gxbg /*LT*/ t
		left join jhdc.clientinfox j
		on j.client_id = t.khid
		left join t_ehr_jjr_jbxx e
		on e.ryid = t.ryid
		<where>
			<if test="sql != null || sql != '' ">
				${sql}
			</if>
<!-- 			<if test="sql = null || sql = '' "> -->
<!-- 				and t.ryid in -->
<!-- 				<foreach collection="ryid" open="(" separator="," close=")" -->
<!-- 					item="item"> -->
<!-- 					#{item} -->
<!-- 				</foreach> -->
<!-- 			</if> -->

			<if test="khid != null">
				and t.khid = #{khid}
			</if>
			<if test="status != null">
				and t.status = #{status}
			</if>
			<if test="beginDate != null">
				and to_char(t.rec_gen_time,'yyyyMMdd') &gt;= #{beginDate}
			</if>
			<if test="endDate != null">
				and to_char(t.rec_gen_time,'yyyyMMdd') &lt;= #{endDate}
			</if>
		</where>
		order by t.rec_gen_time desc )a
	</select>
	<select id="selectGXBG" parameterType="map" resultType="map">
		select *
		from t_gxgl_gxbg where khid =#{khid} and status = 1
	</select>
	<!-- 删除虚拟渠道经纪关系 -->
	<delete id="deleteXN" parameterType="map">
		delete from t_gxgl_gxmx where khid = #{khid} and ryid = #{ryid}
	</delete>

	<!-- 关系流水一览 -->
	<select id="selectGxmxLs" parameterType="map"
		resultType="com.linkstec.crm.custRelation.dto.CR600S01Dto">
		SELECT
		a.ID,
       a.khid,
       a.khxm,
       a.ryid,
       a.ryxm,
       a.czryxm,
       a.fprq,
       a.gxjzrq,
       a.gxly,
       a.czlx,
       a.rec_gen_time,
       a.bz,
       a.shzt,
       a.czryid,
       a.orgid,
       a.org_name,
		(SELECT JG_NAME from L_ORGANIZATION_EXPAND where jgid =
		a.orgid) orgname
		FROM
		T_GXGL_GXMX_LS 
		A
		WHERE 1=1
		<if test="khxm!=null">
			and (a.khxm like '%'|| trim(' ' FROM #{khxm})||'%' or a.khid like
			'%'||trim(' ' FROM #{khxm})||'%')
		</if>
		<if test="czryxm!=null">
			and (a.czryxm like '%'||trim(' ' FROM #{czryxm})||'%' or a.czryid like
			'%'||trim(' ' FROM #{czryxm})||'%')
		</if>
		<if test="fprqStart!=null">
			and to_number(to_char(a.REC_GEN_TIME,'yyyyMMdd'))
			&gt;=to_number(to_char(#{fprqStart},'yyyyMMdd'))
			<!-- and a.REC_GEN_TIME &gt;= #{fprqStart} -->
		</if>
		<if test="fprqEnd!=null">
			and to_number(to_char(a.REC_GEN_TIME,'yyyyMMdd'))
			&lt;=to_number(to_char(#{fprqEnd},'yyyyMMdd'))
			<!-- and a.REC_GEN_TIME &lt;= #{fprqEnd} -->
		</if>
		<if test="branchNo!=null">
			and a.orgid in
			<foreach collection="branchNo" open="(" separator="," close=")"
				item="item">
				#{item}
			</foreach>
		</if>
		<if test="czlx!=null">
			and a.czlx = #{czlx}
		</if>
		<if test="memberName!=null">
			and (a.ryid like trim(' ' FROM #{memberName})
			or a.ryxm like '%'|| trim(' ' FROM #{memberName})||'%' )
		</if>
		order by a.rec_gen_time desc,a.ID desc
	</select>
	
	<insert id="insertGxmxLs" parameterType="com.linkstec.crm.custRelation.po.TGxglGxmxLs">
		insert into t_gxgl_gxmx_ls (khid,ryid,gxjzrq,fprq,khxm,khfldm,ryxm,bl_fc
		,gxly,org_name,orgid,shzt,bz,czryid,czlx,czryxm,gxlxbh,rec_gen_time,rec_upd_time,id,insid)
	values (#{khid},#{ryid},#{gxjzrq},#{fprq},#{khxm},#{khfldm},#{ryxm},#{blFc},#{gxly}
	,#{orgName},#{orgid},#{shzt},#{bz},#{czryid},#{czlx},#{czryxm},#{gxlxbh},sysdate,sysdate,seq_gxmxls2.nextval,#{insid})
	</insert>
</mapper>